<form [formGroup]="form">
    @if (dataPath()) {
        <div>
            <div class="flex-container">
                <mat-form-field appearance="fill">
                    <mat-label>Path to probe file, relative to upload or volume (optional)</mat-label>
                    <input matInput type="text" [(ngModel)]="probeFileDatasetProperties" [ngModelOptions]="{standalone: true}" />
                </mat-form-field>
                <button mat-raised-button class="analyze" (click)="suggestDatasetProperties()">Analyze file and suggest properties</button>
            </div>
            <mat-divider></mat-divider>
        </div>
    }

    <div formGroupName="rasterResultDescriptor">
        <mat-form-field appearance="fill">
            <mat-label>Output Data Type</mat-label>
            <mat-select formControlName="dataType">
                @for (dataType of RasterDataTypes; track dataType) {
                    <mat-option [value]="dataType">
                        {{ dataType }}
                    </mat-option>
                }
            </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill">
            <mat-label>Spatial Reference</mat-label>
            <input matInput type="text" formControlName="spatialReference" />
        </mat-form-field>

        <div formGroupName="spatialGrid">
            <div class="flex-container" formGroupName="geoTransform">
                <mat-form-field>
                    <mat-label>Origin X</mat-label>
                    <input matInput type="number" formControlName="originX" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Origin Y</mat-label>
                    <input matInput type="number" formControlName="originY" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Pixel Size X</mat-label>
                    <input matInput type="number" formControlName="xPixelSize" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Pixel Size Y</mat-label>
                    <input matInput type="number" formControlName="yPixelSize" />
                </mat-form-field>
            </div>

            <div class="flex-container" formGroupName="gridBounds">
                <mat-form-field>
                    <mat-label>Min X Coordinate</mat-label>
                    <input matInput type="number" formControlName="minX" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Min Y Coordinate</mat-label>
                    <input matInput type="number" formControlName="minY" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Max X Coordinate</mat-label>
                    <input matInput type="number" formControlName="maxX" />
                </mat-form-field>
                <mat-form-field>
                    <mat-label>Max Y Coordinate</mat-label>
                    <input matInput type="number" formControlName="maxY" />
                </mat-form-field>
            </div>
        </div>

        <mat-divider></mat-divider>

        <geoengine-manager-timedescriptor
            [timeDescriptor]="form.controls.rasterResultDescriptor.controls.time.value"
            (timeDescriptorChange)="form.controls.rasterResultDescriptor.controls.time.setValue($event); form.markAsDirty()"
        ></geoengine-manager-timedescriptor>

        <mat-divider></mat-divider>

        <geoengine-manager-rasterbands
            [rasterbands]="form.controls.rasterResultDescriptor.controls.bands.value"
            (rasterbandsChange)="form.controls.rasterResultDescriptor.controls.bands.setValue($event); form.markAsDirty()"
        ></geoengine-manager-rasterbands>

        <div class="actions">
            <button mat-raised-button color="primary" [disabled]="form.pristine || form.invalid" (click)="saveMetadata()">Apply</button>
        </div>
    </div>

    <mat-divider></mat-divider>
</form>

<form [formGroup]="tileForm">
    <div class="container">
        <div class="left">
            @if (editMode === EditMode.Created) {
                <button mat-stroked-button class="browseButton" (click)="backToAllTiles()">
                    <mat-icon>chevron_left</mat-icon>Back to all datasets
                </button>
                <mat-nav-list>
                    <mat-list-item class="selected">
                        <h4 matListItemTitle>{{ createdTileName }}</h4>
                        <p matListItemLine>{{ createdTileId }}</p>
                    </mat-list-item></mat-nav-list
                >
            }
            @if (editMode === EditMode.Update || editMode === EditMode.Create) {
                <button mat-raised-button color="primary" class="add-dataset" (click)="addTile()"><mat-icon>add</mat-icon></button>
                <cdk-virtual-scroll-viewport [itemSize]="itemSizePx" (scrolledIndexChange)="onScrolledIndexChange($event)">
                    <mat-nav-list>
                        <ng-container *cdkVirtualFor="let item of source; trackBy: trackById">
                            <mat-list-item [class.selected]="(selectedTileId$ | async) === item.id" (click)="select(item)">
                                <h4 matListItemTitle>{{ tileTitle(item.params.filePath) }}</h4>
                                <p matListItemLine>{{ item.id }}</p>
                            </mat-list-item>
                        </ng-container>
                    </mat-nav-list>

                    @if (source?.loading$ | async) {
                        <mat-spinner [diameter]="loadingSpinnerDiameterPx"></mat-spinner>
                    }
                </cdk-virtual-scroll-viewport>
            }
        </div>

        <div class="tile-editor">
            @switch (editMode) {
                @case (EditMode.Create) {
                    <h2>Create New Tile</h2>
                }
                @case (EditMode.Update) {
                    <h2>Edit Tile {{ selectedTileId$ | async }}</h2>
                }
            }
            <div class="flex-container">
                <mat-form-field appearance="fill">
                    <mat-label>Path to probe file, relative to upload or volume (optional)</mat-label>
                    <input matInput type="text" [(ngModel)]="probeFileTileProperties" [ngModelOptions]="{standalone: true}" />
                </mat-form-field>
                <button mat-raised-button class="analyze" (click)="suggestTileProperties()">Analyze file and suggest properties</button>
            </div>

            <mat-divider></mat-divider>

            <h2>Tile Metadata</h2>

            <h3 class="mat-subtitle-1">Bounding Box</h3>
            <div formGroupName="bbox" class="bbox-fields">
                <mat-form-field appearance="fill">
                    <mat-label>min X</mat-label>
                    <input matInput type="number" formControlName="bboxMinX" />
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>min Y</mat-label>
                    <input matInput type="number" formControlName="bboxMinY" />
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>max X</mat-label>
                    <input matInput type="number" formControlName="bboxMaxX" />
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>max Y</mat-label>
                    <input matInput type="number" formControlName="bboxMaxY" />
                </mat-form-field>
            </div>

            <mat-divider></mat-divider>

            <geoengine-time-interval-input [formControl]="tileForm.controls.time"></geoengine-time-interval-input>

            <mat-divider></mat-divider>

            <mat-form-field appearance="fill">
                <mat-label>Raster Band</mat-label>
                <mat-select formControlName="band">
                    @for (i of bandIndices; track i) {
                        <mat-option [value]="i">
                            {{ form.controls.rasterResultDescriptor.controls.bands.value[i].name || 'Band ' + i }}
                        </mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-divider></mat-divider>

            <mat-form-field appearance="fill">
                <mat-label>Z-Index (higher value means more priority when overlapping with other tiles)</mat-label>
                <input matInput type="number" formControlName="zIndex" />
            </mat-form-field>

            <mat-divider></mat-divider>

            <h2>File Loading Parameters</h2>

            <geoengine-manager-gdal-dataset-parameters
                [form]="tileForm.controls.gdalParameters"
                [dataPath]="dataPath()"
            ></geoengine-manager-gdal-dataset-parameters>

            <div class="actions">
                @switch (editMode) {
                    @case (EditMode.Update) {
                        <button mat-raised-button color="primary" [disabled]="tileForm.pristine || tileForm.invalid" (click)="saveTile()">
                            Apply
                        </button>
                        <button mat-raised-button color="warn" (click)="deleteTile()">Delete</button>
                    }
                    @case (EditMode.Create) {
                        <button mat-raised-button color="primary" [disabled]="tileForm.invalid" (click)="createTile()">Create</button>
                    }
                }
            </div>
        </div>
    </div>
</form>
